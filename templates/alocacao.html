<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Alocação de Polos Interativa</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Libs -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>

    <!-- CSS opcional do projeto -->
    <link rel="stylesheet" href="/static/css/slider-style.css">

    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background: #f3f3f7; zoom: 0.8; transition: background 0.3s, color 0.3s; }
        .top-bar { display:flex; align-items:center; border:2px solid #ffffff; justify-content:center; position:relative; width:100%; background:#fff; box-shadow:0 2px 8px #0001; padding:8px 0 4px 0; min-height:38px; }
        .top-bar .menu { position:absolute; left:16px; top:8px; z-index:1000; }
        .page-title { flex:1; text-align:center; font-size:1.3em; font-weight:bold; color:#1976d2; margin:0 auto; display:flex; align-items:center; justify-content:center; gap:12px; }

        .menu-icon { width: 28px; height: 4px; background: #1976d2; margin: 3px 0; border-radius: 2px; transition: background 0.2s; }
        .menu.open .menu-icon { background: #333; }
        .menu-content { position: absolute; top: 40px; left: 0; min-width: 260px; max-width: 340px; background: #fff; border-radius: 12px; box-shadow: 0 4px 24px #0003; padding: 18px; z-index: 1100; display: none; }
        .menu.open .menu-content { display: block; }
        .menu-link, .menu-content button, .menu-content label { display: block; width: 100%; margin-bottom: 8px; padding: 10px 0; background: linear-gradient(90deg, #1976d2 0%, #43cea2 100%); color: #fff; font-weight: bold; text-align: center; border: none; border-radius: 8px; text-decoration: none; font-size: 1em; cursor: pointer; transition: background 0.2s; }
        .menu-link:hover, .menu-content button:hover { background: linear-gradient(90deg, #43cea2 0%, #1976d2 100%); }
        .menu-content label { background: none; color: #333; margin-bottom: 12px; padding: 0; text-align: left; font-weight: normal; }
        .menu-content > div { margin: 10px 0 2px 0; font-weight: bold; color:#1976d2; }

        .main-flex { display:flex; gap:24px; padding:16px; align-items:stretch; }
        .side-col, .center-col { border: 2px solid #ffffff; border-radius: 10px; background: #fff; padding: 16px; }
        .side-col { width: 360px; flex: 0 0 auto; }
        .center-col { flex: 1 1 auto; }

        .section-title { font-size:1.1em; font-weight:bold; color:#1976d2; margin-bottom:8px; display:flex; align-items:center; gap:6px; }

        /* Ícone informativo: "i" centralizado em qualquer contexto (inclusive modais) */
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            margin-left: 8px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            position: relative;
            text-align: center;
            border-radius: 50%;
            border: 1px solid #1976d2;
            color: #ffffff;
            line-height: 18px; /* garante centrado vertical mesmo sem flex */
            vertical-align: middle;
            user-select: none;
        }
    
        .info-icon:hover .info-tooltip { display:block; }
        .info-tooltip {
            display:none;
            position:absolute;
            top:22px;
            left:50%;
            transform:translateX(-50%);
            background:#fff;
            color:#333;
            padding:8px 12px;
            border-radius:8px;
            box-shadow:0 4px 12px rgba(0,0,0,0.2);
            z-index:100;
            width:400px;
            max-width:400px;
            font-size:1em;
        }

        .param-list { margin-bottom:12px; }
        .param-row { display:flex; align-items:center; gap:6px; margin-bottom:6px; }
        .param-slider { width:80px; min-width:0; margin-right:2px; }
        .input-inline { width:70px; min-width:0; margin-right:2px; }
        input[type="number"].input-inline { border:2px solid #fff !important; background:#ffffff; border-radius:4px; }
        .remove-btn { background:#d9534f; color:#fff; border:none; border-radius:3px; padding:2px 8px; font-size:1em; cursor:pointer; }
        .add-btn { background:#5cb85c; color:#fff; border:none; border-radius:3px; padding:4px 12px; font-size:1em; cursor:pointer; margin:4px 0; }

        .row-flex { display:flex; align-items:center; gap:8px; margin:6px 0; flex-wrap:wrap; }
        .box { border:1px solid #eee; border-radius:8px; padding:12px; background:#fafafa; }
        .highlight { background:#f7fbff; border-color:#e1f0ff; }

        body.dark-mode { background:#121212; color:#e6e6e6; }
        body.dark-mode .side-col, body.dark-mode .center-col, body.dark-mode .box { background:#1e1e1e; border-color:#2a2a2a; }
        body.dark-mode .menu-content { background:#1e1e1e; }
        body.dark-mode .menu-icon { background:#2196f3 !important; }
        body.dark-mode .section-title { color:#fff !important; }

        /* Tamanho do MathJax */
        #latex-controlador mjx-container { font-size: 175% !important; line-height: 1.2; }
        #latex-planta mjx-container { font-size: 175% !important; line-height: 1.2; }
        #poly-caracteristico mjx-container { font-size: 180% !important; line-height: 1.2; display:inline-block; }
        #poly-desejado-latex mjx-container { font-size: 150% !important; }
        #pd-value, #pd-value mjx-container { font-size: 130% !important; line-height: 1.2; }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="menu">
            <button id="menu-toggle-btn" style="background:none;border:none;cursor:pointer;padding:0;margin-right:8px;">
                <div style="display:flex; flex-direction:column;">
                    <div class="menu-icon"></div>
                    <div class="menu-icon"></div>
                    <div class="menu-icon"></div>
                </div>
            </button>
            <div class="menu-content">
                <label>
                    <input id="dark-mode-toggle" type="checkbox">
                    <span id="dark-mode-icon">🌙</span>
                </label>
                <a href="/principal" class="menu-link" style="margin-top:16px;">Página Inicial</a>
                <div>Sinais e Sistemas</div>
                <a href="/sinais" class="menu-link" style="margin-top:0;">Resposta do Sistema</a>
                <div>Controle</div>
                <a href="/raizes" class="menu-link" style="margin-top:0;">Lugar das Raízes</a>
                <a href="/malhaaberta" class="menu-link" style="margin-top:0;">Malha Aberta</a>
                <a href="/simuladorcomp" class="menu-link" style="margin-top:0;">Simulador Completo</a>
                <button id="abrir-feedback" style="margin-top:10px;">Enviar Feedback</button>
            </div>
        </div>
        <div class="page-title">Projeto por Alocação de Polos</div>
    </div>

    <div style="height:10px;"></div>

    <div class="main-flex">
        <!-- Coluna esquerda -->
        <div class="side-col">
            <div class="section-title">
                Parâmetros da Planta
                <span class="info-icon">i
                    <span class="info-tooltip">
                        Os parâmetros da planta incluem polos, zeros e ganho. Eles determinam a dinâmica do sistema em malha aberta.
                        <br><br><b>Polos:</b> Determinam a estabilidade e a velocidade de resposta.
                        <br><b>Zeros:</b> Podem modificar a forma da resposta transitória.
                    </span>
                </span>
            </div>

            <div class="param-list">
                <label>Polos da Planta:</label>
                <div id="planta-polos-list"></div>
                <button class="add-btn" onclick="addParam('planta-polos')">Adicionar Polo</button>
            </div>

            <div class="param-list">
                <label>Zeros da Planta:</label>
                <div id="planta-zeros-list"></div>
                <button class="add-btn" onclick="addParam('planta-zeros')">Adicionar Zero</button>
            </div>

            <div class="param-list">
                <label>Ganho da Planta (K<sub>g</sub>):</label>
                <input type="number" id="ganho-planta" class="input-inline" value="1.0" step="0.01" onchange="onGanhoPlantaChange(this.value)">
            </div>

            <button class="add-btn" onclick="generateRandomFT()">Gerar FT Aleatória</button>
            <div><span class="latex" id="latex-planta"></span></div>

            <div class="section-title" style="margin-top:16px;">
                Parâmetros do Controlador
                <span class="info-icon">i
                    <span class="info-tooltip">
                        Os parâmetros do controlador incluem polos, zeros e ganho. Eles afetam a dinâmica do sistema em malha fechada.
                        <br><br><b>Polos:</b> Afetam estabilidade e tempo de resposta.
                        <br><b>Zeros:</b> Podem cancelar polos indesejados ou ajustar transitório.
                    </span>
                </span>
            </div>

            <div class="param-list">
                <label>Polos do Controlador:</label>
                <div id="controlador-polos-list"></div>
                <button class="add-btn" onclick="addParam('controlador-polos')">Adicionar Polo</button>
            </div>

            <div class="param-list">
                <label>Zeros do Controlador:</label>
                <div id="controlador-zeros-list"></div>
                <button class="add-btn" onclick="addParam('controlador-zeros')">Adicionar Zero</button>
            </div>

            <div class="param-list">
                <label>Ganho do Controlador (K<sub>c</sub>):</label>
                <input type="number" id="ganho-controlador" class="input-inline" value="1.0" step="0.01" onchange="onGanhoControladorChange(this.value)">
            </div>

            <div><span class="latex" id="latex-controlador"></span></div>

            <div class="section-title" style="margin-top:16px;">
                Filtro F(s)
                <span class="info-icon">i
                    <span class="info-tooltip">
                        O filtro F(s) é aplicado à saída do sistema em malha fechada. Configure polos e ganho para simular sua influência.
                    </span>
                </span>
            </div>
            <div style="margin-bottom:10px;">
                <label>
                    <input type="checkbox" id="filtro-ativo" onchange="onFiltroAtivoChange(this.checked)">
                    Ativar Filtro F(s)
                </label>
            </div>
            <div id="filtro-config" style="display:none;">
                <div class="param-list">
                    <label>Polos do Filtro:</label>
                    <div id="filtro-polos-list"></div>
                    <button class="add-btn" onclick="addParam('filtro-polos')">Adicionar Polo</button>
                </div>
                <div class="param-list">
                    <label>Ganho do Filtro (K<sub>f</sub>):</label>
                    <input type="number" id="ganho-filtro" class="input-inline" value="1.0" step="0.01" onchange="onGanhoFiltroChange(this.value)">
                </div>
                <div><span class="latex" id="latex-filtro"></span></div>
            </div>
        </div>

        <!-- Coluna central -->
        <div class="center-col">
            <div class="main-content-flex">
                <div class="conteudo-central">
                    <div class="box highlight">
                        <div class="row-flex">
                            <label>Tempo de assentamento (5%) da malha aberta:</label>
                            <input type="text" id="ts-aberta" class="input-inline" readonly>
                            <span class="info-icon" id="ts-modal-trigger" style="cursor:pointer;">i</span>
                        </div>

                        <div class="row-flex">
                            <label>Tempo de assentamento desejado (malha fechada):</label>
                            <input type="text" id="ts-desejado" class="input-inline" readonly>
                            <span style="margin-left: 12px;">(Multiplicador:</span>
                            <input type="number" id="ts-multiplier" class="input-inline" value="0.5" step="0.1" onchange="updateAll()">
                            <span>)</span>
                        </div>

                        <div class="row-flex">
                            <label>Tempo de assentamento real (malha fechada):</label>
                            <input type="text" id="ts-fechada" class="input-inline" readonly>
                        </div>

                        <div class="row-flex" style="margin-top:10px;">
                            <label><b>Ordem do polinômio desejado:</b></label>
                            <select id="ordem-desejada" class="input-inline" onchange="onDesejadoChanged()"style="width:auto;">
                                <option value="1">1ª</option>
                                <option value="2" selected>2ª</option>
                                <option value="3">3ª</option>
                            </select>
                        </div>

                        <div id="opt-2ordem" class="row-flex" style="margin-top:8px; display:none;">
                            <label>Tipo (2ª ordem):</label>
                            <select id="tipo-2ordem" class="input-inline" onchange="onTipo2Changed()" style="width:auto;">
                                <option value="2nd_equal" selected>Iguais</option>
                                <option value="2nd_distinct">Distintos</option>
                            </select>
                        </div>

                        <div class="row-flex" style="margin-top:8px;">
                            <span class="latex" id="pd-value"></span>
                            <span class="info-icon" onclick="abrirModalPd()" style="cursor:pointer;">i</span>
                        </div>

                        <div id="poly-desejado-expl" style="margin-top:18px; font-size:1.08em;">
                            <b>Sugestão de polinômio desejado aproximado:</b> <span class="latex" id="poly-desejado-latex"></span>
                           
                            <div style="margin-top:8px; font-size:0.98em;">
                                <b>Como chegar no polinômio desejado?</b>
                                <ul>
                                    <li>Ajuste polos/zeros/ganhos para igualar o polinômio característico atual à sugestão.</li>
                                </ul>
                            </div>
                        </div>

                        <div class="row-flex">
                            <label><b>Polinômio característico atual:</b></label>
                            <span class="latex" id="poly-caracteristico"></span>
                            <span class="info-icon" onclick="abrirModalPmf()" style="cursor:pointer;">i</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="graficos-flex" style="margin-top: 24px; display: flex; gap: 24px;">
                <div class="grafico-col" style="flex: 1 1 0;">
                    <label style="font-weight:bold;">Resposta ao Degrau:</label>
                    <div class="box" style="margin-top:8px;">
                        <select id="tipo-resposta" style="margin-left:0; width:140px;" onchange="updateAll()">
                            <option value="aberta">Malha Aberta</option>
                            <option value="fechada">Malha Fechada</option>
                            <option value="erro">Erro E/R</option>
                            <option value="perturbacao">Y/Q</option>
                        </select>
                        <div id="plot-resposta" style="width:100%; height:320px;"></div>
                    </div>
                </div>

                <div class="grafico-col" style="flex: 1 1 0;">
                    <label style="font-weight:bold;">Diagrama de Polos e Zeros:</label>
                    <div class="box" style="margin-top:8px;">
                        <select id="tipo-pz" style="margin-left:0; width:140px;" onchange="updateAll()">
                            <option value="malha_fechada" selected>Malha Fechada</option>
                            <option value="malha_aberta">Malha Aberta</option>
                            <option value="erro">E/R</option>
                            <option value="perturbacao">Y/Q</option>
                        </select>
                        <div id="plot-pz" style="width:100%; height:320px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal PMF -->
    <div id="modal-pmf" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:1000;">
        <div style="background:#fff; max-width:540px; margin:60px auto; border-radius:12px; box-shadow:0 4px 24px #0003; padding:32px 28px 24px 28px; position:relative;">
            <span style="position:absolute; top:12px; right:18px; font-size:1.5em; cursor:pointer; color:#0074d9;" onclick="fecharModalPmf()">&times;</span>
            <div style="font-size:1.1em; margin-bottom:18px;">
                <b>Como calcular o polinômio característico desejado (<span style="font-family:serif;">P<sub>mf,desejado</sub></span>):</b>
            </div>
            <div style="font-size:1em;">
                <b>Estrutura geral:</b>
                <br>
                \( P_{mf}(s) = D_{g}(s) D_c(s) + N_{g}(s) N_c(s) \)
                
            </div>
        </div>
    </div>

    <!-- Modal TS -->
    <div id="modal-ts" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:1001;">
        <div style="background:#fff; max-width:540px; margin:60px auto; border-radius:12px; box-shadow:0 4px 24px #0003; padding:32px 28px 24px 28px; position:relative;">
            <span style="position:absolute; top:12px; right:18px; font-size:1.5em; cursor:pointer; color:#0074d9;" onclick="fecharModalTs()">&times;</span>
            <div style="font-size:1.1em; margin-bottom:18px;">
                <b>Como é calculado o tempo de assentamento (5%)?</b>
            </div>
            <div style="font-size:1em;">
                <ul style="margin:6px 0 0 18px;">
                    <li>1 Polo: \( T_{5\%} = 3/P_g \)</li>
                    <li>2 Polos (iguais): \( T_{5\%} = 4.8/P_g \)</li>
                    <li>2 Polos (distintos): \( T_{5\%} = 3/P_{Lento} + 1.5/P_{Rápido} \)</li>
                    <li>3 Polos (iguais): \( T_{5\%} ≈ 6.3/P_g \)</li>
                </ul>
                <div style="margin-top:10px;" id="ts-explicacao-modal"></div>
            </div>
        </div>
    </div>

    <!-- Modal Pd -->
    <div id="modal-pd" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:1001;">
        <div style="background:#fff; max-width:540px; margin:60px auto; border-radius:12px; box-shadow:0 4px 24px #0003; padding:32px 28px 24px 28px; position:relative;">
            <span style="position:absolute; top:12px; right:18px; font-size:1.5em; cursor:pointer; color:#0074d9;" onclick="fecharModalPd()">&times;</span>
            <div style="font-size:1.1em; margin-bottom:18px;"><b>Fórmula de P<sub>d</sub></b></div>
            <div style="font-size:1em;">
                <ul style="margin:6px 0 0 18px;">
                    <li>1ª ordem: \( P_d = 3/T_{s,fechada} \)</li>
                    <li>2ª ordem: \( P_d = 4.8/T_{s,fechada} \)</li>
                    <li>3ª ordem: \( P_d = 6.3/T_{s,fechada} \)</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Estado
        let polos_planta = [-0.01];
        let zeros_planta = [];
        let polos_controlador = [];
        let zeros_controlador = [];
        let ganho_controlador = 1.0;
        let ganho_planta = 1.0;
        let filtro_ativo = false;
        let polos_filtro = [];
        let ganho_filtro = 1.0;

        // Debounce
        function debounce(func, wait) { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>func.apply(this,a), wait); }; }
        const updateAllDebounced = debounce(updateAll, 30);

        // Render parâmetros
        function renderParamList(listId, arr, type) {
            const container = document.getElementById(listId);
            container.innerHTML = '';
            arr.forEach((val, idx) => {
                const row = document.createElement('div');
                row.className = 'param-row';
                const min = -10, max = 10, step = 0.01;
                row.innerHTML = `
                    <input type="range" class="param-slider" id="${type}-slider-${idx}" min="${min}" max="${max}" step="${step}" value="${val}">
                    <input type="number" class="input-inline" id="${type}-input-${idx}" value="${val}">
                    <button class="remove-btn" onclick="removeParam('${type}',${idx})">x</button>
                `;
                container.appendChild(row);

                document.getElementById(`${type}-input-${idx}`).oninput = function() {
                    const val = parsePoloInput(this.value);
                    // Se parte imaginária existe, salva como array [real, imag]
                    arr[idx] = val.imag !== 0 ? [val.real, val.imag] : val.real;
                    document.getElementById(`${type}-slider-${idx}`).value = val.real;
                    updateAllDebounced();
                };
                document.getElementById(`${type}-slider-${idx}`).oninput = function() {
                    arr[idx] = parseFloat(this.value);
                    document.getElementById(`${type}-input-${idx}`).value = this.value;
                    updateAllDebounced();
                };
            });
        }
        function renderFiltroParamList() {
            const container = document.getElementById('filtro-polos-list');
            container.innerHTML = '';
            polos_filtro.forEach((val, idx) => {
                const row = document.createElement('div');
                row.className = 'param-row';
                row.innerHTML = `
                    <input type="range" class="param-slider" id="filtro-polos-slider-${idx}" min="-10" max="10" step="0.01" value="${val}">
                    <input type="number" class="input-inline" id="filtro-polos-input-${idx}" step="0.01" value="${val}">
                    <button class="remove-btn" onclick="removeFiltroPolo(${idx})">x</button>
                `;
                container.appendChild(row);

                document.getElementById(`filtro-polos-input-${idx}`).oninput = function() {
                    polos_filtro[idx] = parseFloat(this.value);
                    document.getElementById(`filtro-polos-slider-${idx}`).value = this.value;
                    updateAllDebounced();
                };
                document.getElementById(`filtro-polos-slider-${idx}`).oninput = function() {
                    polos_filtro[idx] = parseFloat(this.value);
                    document.getElementById(`filtro-polos-input-${idx}`).value = this.value;
                    updateAllDebounced();
                };
            });
        }
        function addParam(type) {
            if (type === 'planta-polos') polos_planta.push(-1);
            if (type === 'planta-zeros') zeros_planta.push(0);
            if (type === 'controlador-polos') polos_controlador.push(-1);
            if (type === 'controlador-zeros') zeros_controlador.push(0);
            if (type === 'filtro-polos') polos_filtro.push(-1);
            updateParamLists(); renderFiltroParamList(); updateAll();
        }
        function removeParam(type, idx) {
            if (type === 'planta-polos') polos_planta.splice(idx, 1);
            if (type === 'planta-zeros') zeros_planta.splice(idx, 1);
            if (type === 'controlador-polos') polos_controlador.splice(idx, 1);
            if (type === 'controlador-zeros') zeros_controlador.splice(idx, 1);
            updateParamLists(); updateAll();
        }
        function removeFiltroPolo(idx) {
            polos_filtro.splice(idx, 1);
            renderFiltroParamList();
            updateAll();
        }
        function onGanhoPlantaChange(value) { ganho_planta = parseFloat(value); updateAll(); }
        function onGanhoControladorChange(value) { ganho_controlador = parseFloat(value); updateAll(); }
        function onGanhoFiltroChange(value) {
            ganho_filtro = parseFloat(value);
            updateAll();
        }
        function onFiltroAtivoChange(checked) {
            filtro_ativo = checked;
            document.getElementById('filtro-config').style.display = checked ? 'block' : 'none';
            updateAll();
        }
        function updateParamLists() {
            renderParamList('planta-polos-list', polos_planta, 'planta-polos');
            renderParamList('planta-zeros-list', zeros_planta, 'planta-zeros');
            renderParamList('controlador-polos-list', polos_controlador, 'controlador-polos');
            renderParamList('controlador-zeros-list', zeros_controlador, 'controlador-zeros');
            document.getElementById('ganho-controlador').value = ganho_controlador;
            document.getElementById('ganho-planta').value = ganho_planta;
            renderFiltroParamList();
            document.getElementById('ganho-filtro').value = ganho_filtro;
        }

        // Helpers LaTeX
        function countZeroAtZero(arr, tol=1e-8){ if(!Array.isArray(arr)) return 0; return arr.filter(v=>Math.abs(parseFloat(v))<tol).length; }
        function effectiveZeroPoles(arr, tol=1e-8){ if(!Array.isArray(arr)||arr.length===0) return 1; return countZeroAtZero(arr,tol); }
        function fixFracWithS(latex,kZeros,kPoles,varName='s'){
            if(!latex) return latex;
            const sZeros=kZeros>1?`${varName}^${kZeros}`:varName;
            const sPoles=kPoles>1?`${varName}^${kPoles}`:varName;
            return latex.replace(/\\frac\{\s*([^}]*)\s*\}\{\s*([^}]*)\s*\}/g,(m,num,den)=>{
                let newNum=num.trim(); let newDen=den.trim();
                if(kZeros>0&&/^1\s*$/.test(newNum)) newNum=sZeros;
                if(kPoles>0&&/^1\s*$/.test(newDen)) newDen=sPoles;
                return `\\frac{${newNum}}{${newDen}}`;
            });
        }
        function ensureWrappedLatex(s){
            if(!s) return '';
            const t=String(s).trim();
            if (/^\\\(|^\\\[|^\$|^<mjx-container/.test(t)) return t;
            return `\\(${t}\\)`;
        }
        function typesetSafe(attempt=0){
            if (window.MathJax && MathJax.typesetPromise) {
                MathJax.typesetPromise();
            } else if (attempt < 20) {
                setTimeout(()=>typesetSafe(attempt+1),150);
            }
        }

        // Atualiza tudo
        function updateAll() {
            try {
                if (zeros_planta.length > polos_planta.length) { alert("A função de transferência da planta está não própria!"); return; }
                if (zeros_controlador.length > polos_controlador.length) { alert("A função de transferência do controlador está não própria!"); return; }

                const multiplier = parseFloat(document.getElementById('ts-multiplier').value) || 0.5;
                const tipoResposta = document.getElementById('tipo-resposta')?.value || "aberta";
                const tipoPZ = document.getElementById('tipo-pz')?.value || "malha_fechada";
                const ordemDesejada = parseInt(document.getElementById('ordem-desejada').value || '2');
                const tipo2 = document.getElementById('tipo-2ordem')?.value || '2nd_equal';

                fetch('/alocacao_polos_backend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        polos_planta, zeros_planta, polos_controlador, zeros_controlador,
                        ganho_controlador, ganho_planta, ts_multiplier: multiplier,
                        desired_order: ordemDesejada,
                        desired_poles_type: tipo2,
                        filtro_ativo,
                        polos_filtro,
                        ganho_filtro
                    })
                })
                .then(resp => resp.json())
                .then((data) => {
                    // Tempos
                    document.getElementById('ts-aberta').value   = (data.tempo_assentamento_aberta   !== undefined ? data.tempo_assentamento_aberta + " s" : "");
                    document.getElementById('ts-fechada').value  = (data.tempo_assentamento_fechada  !== undefined ? data.tempo_assentamento_fechada + " s" : "");
                    document.getElementById('ts-desejado').value = (data.ts_desejado                  !== undefined ? data.ts_desejado + " s" : "");

                    // Pd
                    document.getElementById('pd-value').innerHTML = data.pd_value ? ensureWrappedLatex(data.pd_value) : '';

                    // FT planta/controlador
                    if (data.latex_planta !== undefined) {
                        const kZP0 = countZeroAtZero(zeros_planta);
                        const kPP0 = effectiveZeroPoles(polos_planta);
                        const latex = ensureWrappedLatex(fixFracWithS(data.latex_planta, kZP0, kPP0, 's'));
                        document.getElementById('latex-planta').innerHTML = latex;
                    }
                    if (data.latex_controlador !== undefined) {
                        const kZC0 = countZeroAtZero(zeros_controlador);
                        const kPC0 = effectiveZeroPoles(polos_controlador);
                        const latex = ensureWrappedLatex(fixFracWithS(data.latex_controlador, kZC0, kPC0, 's'));
                        document.getElementById('latex-controlador').innerHTML = latex;
                    }

                    // Polinômios
                    if (data.poly_caracteristico !== undefined) {
                        document.getElementById('poly-caracteristico').innerHTML = ensureWrappedLatex(data.poly_caracteristico);
                    }
                    if (data.poly_desejado !== undefined) {
                        document.getElementById('poly-desejado-latex').innerHTML = ensureWrappedLatex(data.poly_desejado);
                    }

                    // Tipografia
                    typesetSafe();

                    // Respostas
                    const mapKey = { aberta: 'plot_open', fechada: 'plot_closed', erro: 'plot_er', perturbacao: 'plot_yq' };
                    let key = mapKey[tipoResposta] || 'plot_closed';

                    // Se filtro está ativo e resposta é fechada, use o gráfico filtrado
                    if (filtro_ativo && tipoResposta === 'fechada' && data.plot_closed_filt) {
                        Plotly.newPlot('plot-resposta', data.plot_closed_filt.data, data.plot_closed_filt.layout, { responsive: true });
                    } else if (data[key] && data[key].data && data[key].layout) {
                        Plotly.newPlot('plot-resposta', data[key].data, data[key].layout, { responsive: true });
                    } else {
                        Plotly.purge('plot-resposta');
                    }

                    // PZ via endpoint dedicado
                    updatePZ(tipoPZ, data);
                })
                .catch(err => console.error('Erro ao atualizar (alocacao_polos_backend):', err));
            } catch(e) {
                console.error('Erro inesperado em updateAll:', e);
            }
        }

        // PZ
        function updatePZ(tipoPZ, backendData=null) {
            // Se filtro está ativo e tipo é malha fechada, use o plot_pz_closed do backend
            if (filtro_ativo && tipoPZ === "malha_fechada" && backendData && backendData.plot_pz_closed) {
                const plot = backendData.plot_pz_closed;
                if (plot && plot.data && plot.layout) {
                    Plotly.newPlot('plot-pz', plot.data, plot.layout, { responsive: true });
                } else {
                    Plotly.purge('plot-pz');
                }
                return;
            }
            // Caso normal: consulta o endpoint dedicado
            fetch('/atualizar_pz_closed', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    polos_planta, zeros_planta, polos_controlador, zeros_controlador,
                    ganho_controlador, ganho_planta, tipo: tipoPZ
                })
            })
            .then(r => r.json())
            .then(d => {
                const plot = d.plot || d.plot_pz || d.plot_pz_closed || d.plot_pz_open || null;
                if (plot && plot.data && plot.layout) {
                    Plotly.newPlot('plot-pz', plot.data, plot.layout, { responsive: true });
                } else if (d.data && d.layout) {
                    Plotly.newPlot('plot-pz', d.data, d.layout, { responsive: true });
                } else {
                    Plotly.purge('plot-pz');
                }
            })
            .catch(err => console.error('Erro ao atualizar PZ:', err));
        }

        // Controles dos desejados
        function onDesejadoChanged() {
            atualizarTextoModalPMF();
            update2ordemControls();
            updateAll();
        }

        // Texto do modal PMF
        function atualizarTextoModalPMF() {
            const ordem = document.getElementById('ordem-desejada').value;
            const tipo = document.getElementById('tipo-2ordem')?.value || '2nd_equal';
            let html = '';
            if (ordem === '1') {
                html = `
                    <div><b>1ª ordem (polo real):</b> T_{5%} = 3/P_d ⇒ P_d = 3/T_{s,fechada}.</div>
                    <div>D_{mf,d}(s) = s + P_d.</div>
                    <div style="margin-top:8px;">
                        <b>Exemplo:</b> Se o polo da planta é <b>a</b>, então:<br>
                        \\( D_{mf}(s) = s + a + k_c \\)
                    </div>
                `;
            } else if (ordem === '2') {
                html = `
                    <div><b>2ª ordem (2 reais iguais ou distintos):</b> T_{5%} = 4.8/P_d ⇒ P_d = 4.8/T_{s,fechada}.</div>
                    <div>D_{mf,d}(s) = s^2 + (a + k k_c)s + k_c z</div>
                    <div style="margin-top:8px;">
                        <b>Exemplo:</b> Se o polo da planta é <b>1.82</b>, então:<br>
                        \\( D_{mf}(s) = s^2 + (1.82 + k k_c)s + k_c z \\)
                    </div>
                `;
            } else if (ordem === '3') {
                html = `
                    <div><b>3ª ordem (três reais iguais):</b> T_{5%} ≈ 6.3/P_d ⇒ P_d = 6.3/T_{s,fechada}.</div>
                    <div>D_{mf,d}(s) = (s + P_d)^3.</div>
                    <div style="margin-top:8px;">
                        <b>Exemplo:</b> Se o polo da planta é <b>a</b>, então:<br>
                        \\( D_{mf}(s) = (s + a + k_c)^3 \\)
                    </div>
                `;
            }
            const el = document.getElementById('poly-fechada-info-modal');
            if (el) { el.innerHTML = html; if (window.MathJax) MathJax.typesetPromise(); }
        }

        function update2ordemControls(){
            const ordem = document.getElementById('ordem-desejada').value;
            const cont = document.getElementById('opt-2ordem');
            cont.style.display = (ordem === '2') ? 'flex' : 'none';
        }
        function onTipo2Changed(){ update2ordemControls(); updateAll(); }

        // Modais (abrir/fechar, clique fora e ESC)
        function abrirModalPmf(){ const m=document.getElementById('modal-pmf'); if(m) m.style.display='block'; }
        function fecharModalPmf(){ const m=document.getElementById('modal-pmf'); if(m) m.style.display='none'; }
        function abrirModalTs(){ const m=document.getElementById('modal-ts'); if(m) m.style.display='block'; }
        function fecharModalTs(){ const m=document.getElementById('modal-ts'); if(m) m.style.display='none'; }
        function abrirModalPd(){ const m=document.getElementById('modal-pd'); if(m) m.style.display='block'; }
        function fecharModalPd(){ const m=document.getElementById('modal-pd'); if(m) m.style.display='none'; }

        document.addEventListener('DOMContentLoaded', function () {
            // Menu hover
            const menu = document.querySelector('.menu');
            const menuContent = document.querySelector('.menu-content');
            const menuBtn = document.getElementById('menu-toggle-btn');
            let closeMenuTimeout = null;
            function openMenu(){ if (closeMenuTimeout){ clearTimeout(closeMenuTimeout); closeMenuTimeout=null; } menu.classList.add('open'); menuContent.style.display='block'; }
            function closeMenu(){ menu.classList.remove('open'); menuContent.style.display='none'; }
            menuBtn.addEventListener('mouseenter', openMenu);
            menu.addEventListener('mouseenter', openMenu);
            menu.addEventListener('mouseleave', function(){ closeMenuTimeout=setTimeout(closeMenu, 300); });

            // Dark mode
            const darkToggle = document.getElementById('dark-mode-toggle');
            const darkIcon = document.getElementById('dark-mode-icon');
            function setDarkMode(enabled){ document.body.classList.toggle('dark-mode', enabled); darkIcon.textContent = enabled ? '🌞' : '🌙'; localStorage.setItem('dark-mode', enabled); }
            const darkModeEnabled = localStorage.getItem('dark-mode') === 'true';
            darkToggle.checked = darkModeEnabled; setDarkMode(darkModeEnabled);
            darkToggle.addEventListener('change', e => setDarkMode(e.target.checked));

            // Ícone TS abre modal
            document.getElementById('ts-modal-trigger').onclick = function() { abrirModalTs(); };

            // Clique fora fecha modais
            ['modal-pmf','modal-ts','modal-pd'].forEach(id=>{
                const m=document.getElementById(id);
                if(m){ m.addEventListener('click', (e)=>{ if(e.target===m) m.style.display='none'; }); }
            });
            // Tecla ESC fecha modais
            document.addEventListener('keydown', (e)=>{
                if(e.key==='Escape'){ ['modal-pmf','modal-ts','modal-pd'].forEach(id=>{ const m=document.getElementById(id); if(m) m.style.display='none'; }); }
            });

            // Feedback (se existir na página principal)
            document.getElementById('abrir-feedback')?.addEventListener('click', function () {
                const m=document.getElementById('modal-feedback'); if(m) m.style.display='block';
            });

            // Inicializações
            updateParamLists();
            atualizarTextoModalPMF();
            update2ordemControls();
            updateAll();
        });

        function parsePoloInput(str) {
    str = String(str).replace(/\s+/g, '');
    // Aceita "a+b", "a-b", "a+-b", "a--b"
    const match = str.match(/^([+-]?\d*\.?\d+)(?:([+-]{1,2}\d*\.?\d+))?$/);
    if (match) {
        const real = parseFloat(match[1]);
        const imag = match[2] ? parseFloat(match[2].replace('+-', '-').replace('--', '+')) : 0;
        return { real, imag };
    }
    // Se não bater, tenta só número
    const val = parseFloat(str);
    return { real: isNaN(val) ? 0 : val, imag: 0 };
}
    </script>
</body>
</html>