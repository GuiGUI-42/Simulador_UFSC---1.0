<!DOCTYPE html>
<html>
<head>
    <title>Simulador de Controle - P√°gina 4</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
    <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
    <link rel="stylesheet" href="/static/css/slider-style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
    .right-section {
        overflow: visible !important;
        height: auto !important;
        max-height: none !important;
    }
    .left-section {
        overflow: visible !important;
        height: auto !important;
        max-height: none !important;
    }
    html, body {
        height: 100%;
        overflow-y: auto;
    }
    body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background: #f3f3f7;
            zoom: 0.9;
            transition: background 0.3s, color 0.3s;
    }
   
    .main-container {
        align-items: flex-start !important;
    }
    /* FOR√áA O ESTILO DOS LINKS DO MENU COMO NA PAGINA2 */
    .menu-link {
        display: block !important;
        margin: 12px 0 0 0 !important;
        padding: 8px 16px !important;
        background: linear-gradient(90deg, #2196f3 0%, #4caf50 100%) !important;
        color: #fff !important;
        text-decoration: none !important;
        border-radius: 6px !important;
        font-weight: bold !important;
        text-align: center !important;
        transition: background 0.3s, color 0.3s, box-shadow 0.3s !important;
        box-shadow: 0 2px 6px rgba(33,150,243,0.08) !important;
        font-size: 1.1em !important;
    }
    .menu-link:hover {
        background: linear-gradient(90deg, #4caf50 0%, #2196f3 100%) !important;
        color: #fff !important;
        box-shadow: 0 4px 12px rgba(33,150,243,0.18) !important;
        text-decoration: none !important;
    }
    /* √çcones do menu hamburguer igual pagina2 */
    .menu-icon {
        width: 28px;
        height: 4px;
        background: #1976d2;
        margin: 3px 0;
        border-radius: 2px;
    }
    /* Menu hamburguer igual pagina2 */
    .menu-content {
        display: none;
        position: absolute;
        left: 40px;
        top: 0;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        padding: 18px 18px 18px 18px;
        min-width: 260px;
        z-index: 1001;
    }
    .menu.open .menu-content,
    .menu:hover .menu-content,
    .menu:focus-within .menu-content {
        display: block;
    }
    .menu.open,
    .menu:hover,
    .menu:focus-within {
        z-index: 1002;
    }

    #select-ft-planta,
    #select-ft-controlador {
        width: 85px;
        font-size: 0.75em;
        padding: 1px 2px;
    }

    .input-row {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 6px;
    }
    .param-slider {
        width: 70px;
        min-width: 0;
        margin-right: 2px;
    }
    input[type="number"] {
        border: 2px solid #ffffff;
        border-radius: 4px;
        outline: none;
        width: 55px !important;
        min-width: 0;
        margin-right: 2px;
        font-size: 0.95em;
        padding: 2px 4px;
        background: #ffffff;
    }
    </style>
</head>
<body style="margin:0; background:#f3f3f7;">
    <!-- Menu de hamb√∫rguer -->
    <div class="menu" style="position:fixed; top:8px; left:8px; z-index:1000;">
        <div style="display:flex; flex-direction:column; margin-right:8px;">
            <div class="menu-icon"></div>
            <div class="menu-icon"></div>
            <div class="menu-icon"></div>
        </div>
        <div class="menu-content">
            <label>
                <input id="dark-mode-toggle" type="checkbox">
                <span id="dark-mode-icon">üåô</span>
            </label>
             <a href="/principal" class="menu-link" style="margin-top:16px;">P√°gina Inicial</a>
            <div style="margin-top:10px; margin-bottom:2px; font-weight:bold; color:#1976d2;">Modelagem</div>
            <a href="/state" class="menu-link" style="margin-top:0;">Espa√ßo de Estados</a>
            <div style="margin-top:16px; margin-bottom:2px; font-weight:bold; color:#1976d2;">Sinais e Sistemas</div>
            <a href="/sinais" class="menu-link" style="margin-top:0;">Resposta do Sistema</a>
            <div style="margin-top:16px; margin-bottom:2px; font-weight:bold; color:#1976d2;">Controle</div>
            <a href="/alocacao" class="menu-link" style="margin-top:0;">Aloca√ß√£o de Polos</a>
            <a href="/raizes" class="menu-link" style="margin-top:0;">Lugar das Ra√≠zes</a>
            <a href="/malhaaberta" class="menu-link" style="margin-top:0;">Malha Aberta</a>
            <a href="/blocos" class="menu-link" style="margin-top:0;">Diagrama de Blocos</a>
            <a href="/pid" class="menu-link" style="margin-top:0;">Avan√ßado (PID)</a>
            <a href="/discreto" class="menu-link" style="margin-top:0;">Discreto</a>
           
            <button id="abrir-feedback" style="margin-top:10px;">Enviar Feedback</button>
        </div>

        </div>

    <!-- Espa√ßo para n√£o sobrepor o conte√∫do -->
    <div style="height:56px;"></div>

    <!-- Container principal ocupando toda a tela -->
    <div class="main-container" style="
        display: flex;
        flex-direction: row;
        gap: 24px;
        width: 100vw;
        align-items: stretch;
        box-sizing: border-box;
        justify-content: center;
        padding-left: 24px;
        padding-right: 24px;
    ">
        <!-- Se√ß√£o Esquerda -->
        <div class="left-section" style="
            flex: 0 0 30%;
            width: 30%;
            overflow: visible;
            padding: 1px 16px 16px 16px;
            box-sizing: border-box;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px #0001;
            min-width: 350px;
            margin-bottom: 0;
            position: sticky;
            top: 56px;
            z-index: 10;
        ">
            <div id="parametros-fixos" style="margin-bottom: 4px;">
                <h3>Ajuste de Par√¢metros</h3>
                <div style="margin-bottom: 5px;">
                    <h4>Planta</h4>
                    <div style="display: flex; gap: 10px;">
                        <div class="param-section" id="planta-polos-section">
                            <div class="param-title" style="font-size:1em;font-weight:normal;margin-bottom:2px;">Polos da Planta:</div>
                            <div id="planta-polos-list"></div>
                            <button type="button" class="add-btn" id="add-planta-polo-btn">Adicionar Polo</button>
                        </div>
                        <div class="param-section" id="planta-zeros-section">
                            <div class="param-title" style="font-size:1em;font-weight:normal;margin-bottom:2px;">Zeros da Planta:</div>
                            <div id="planta-zeros-list"></div>
                            <button type="button" class="add-btn" id="add-planta-zero-btn">Adicionar Zero</button>
                        </div>
                    </div>
                    <!-- FT da Planta logo abaixo dos par√¢metros da planta -->
                    <div style="margin-top: 16px;">
                        <b>Fun√ß√£o de Transfer√™ncia da Planta:</b>
                        <select id="select-ft-planta" style="margin-left: 8px;">
                            <option value="fatorada">Fatorada</option>
                            <option value="polinomial">Polinomial</option>
                            <option value="parcial">Fra√ß√£o Parcial</option>
                        </select>
                        <div id="ft-planta-fatorada" class="latex-container" style="margin-top: 8px; word-break: break-word; max-width: 100%;"></div>
                        <div id="ft-planta-polinomial" class="latex-container" style="margin-top: 8px; display: none; word-break: break-word; max-width: 100%;"></div>
                        <div id="ft-planta-parcial" class="latex-container" style="margin-top: 8px; display: none; word-break: break-word; max-width: 100%;"></div>
                    </div>
                </div>
            </div>
            <div style="
                margin-bottom: 0;
                background: #ffffff;
                border-radius: 8px;
                padding: 5px 16px 16px 16px;
                border-top-left-radius: 0;
                border-top-right-radius: 0;
                box-shadow: 0 -1px 4px rgba(255, 255, 255, 0.067);
                position: relative;
            ">
                <h3 style="margin-top:0;">Controlador</h3>
                <div style="display: flex; gap: 10px;">
                    <div>
                        <div class="param-title" style="font-size:1em;font-weight:normal;margin-bottom:2px;">Polos do Controlador</div>
                        <div id="controlador-polos-list"></div>
                        <button type="button" class="add-btn" id="add-controlador-polo-btn">Adicionar Polo</button>
                    </div>
                    <div>
                        <div class="param-title" style="font-size:1em;font-weight:normal;margin-bottom:2px;">Zeros</div>
                        <div id="controlador-zeros-list"></div>
                        <button type="button" class="add-btn" id="add-controlador-zero-btn">Adicionar Zero</button>
                    </div>
                </div>
                <div style="margin-bottom: 12px;">
                    <span>Ganho (Kc):</span>
                    <input id="ganho-controlador" type="number" min="-10" max="20" step="0.01" value="1" style="width: 80px; margin-left: 8px;">
                </div>
                <div style="margin-top: 16px;">
                    <b>Fun√ß√£o de Transfer√™ncia do Controlador:</b>
                    <select id="select-ft-controlador" style="margin-left: 8px;">
                        <option value="fatorada">Fatorada</option>
                        <option value="polinomial">Polinomial</option>
                        <option value="parcial">Fra√ß√£o Parcial</option>
                    </select>
                    <div id="ft-controlador-fatorada" class="latex-container" style="margin-top: 8px; word-break: break-word; max-width: 100%;"></div>
                    <div id="ft-controlador-polinomial" class="latex-container" style="margin-top: 8px; display: none; word-break: break-word; max-width: 100%;"></div>
                    <div id="ft-controlador-parcial" class="latex-container" style="margin-top: 8px; display: none; word-break: break-word; max-width: 100%;"></div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o Direita -->
        <div class="right-section" style="
            flex: 1 1 0;
            width: 0;
            overflow: visible;
            padding: 16px;
            box-sizing: border-box;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px #0001;
            min-width: 350px;
            margin-bottom: 0;
            display: flex;
            flex-direction: column;
        ">
            <h3>Gr√°ficos</h3>

            <!-- Resposta ao Degrau (Malha Fechada) -->
            <div style="display: flex; align-items: center; margin-bottom: 4px;">
                <button id="seta-grafico-closed" class="seta-grafico-btn" style="background:none;border:none;font-size:1.3em;cursor:pointer;color:#2196f3;margin-right:6px;">&#x25BC;</button>
                <h4 style="margin: 0 8px 0 0;">Resposta ao Degrau </h4>
            </div>
            <div id="container-plot-closed" style="margin-bottom: 16px; display:none;">
                <!-- Par√¢metros da Perturba√ß√£o dentro do container do gr√°fico -->
                <div style="display: flex; gap: 16px; align-items: center; margin-bottom: 8px;">
                    <span style="font-weight: bold; color: #1976d2;">Par√¢metros da Perturba√ß√£o:</span>
                    <label for="input-t-fechada-grafico">Tempo:</label>
                    <input id="input-t-fechada-grafico" type="number" min="0" max="50" step="0.1" value="20" style="width: 60px;">
                    <label for="input-a-fechada-grafico">Amplitude:</label>
                    <input id="input-a-fechada-grafico" type="number" min="-2" max="2" step="0.01" value="0" style="width: 60px;">
                </div>
                <div id="plot_closed"></div>
            </div>

            <!-- Diagrama de Polos e Zeros (Malha Fechada) -->
            <div style="display: flex; align-items: center; margin-bottom: 4px; margin-top: 16px;">
                <button id="seta-grafico-pz-closed" class="seta-grafico-btn" style="background:none;border:none;font-size:1.3em;cursor:pointer;color:#2196f3;margin-right:6px;">&#x25BC;</button>
                <h4 style="margin: 0 8px 0 0;">Diagrama de Polos e Zeros</h4>
                <!-- Novo seletor de tipo de diagrama -->
                <select id="tipo-diagrama-pz" style="margin-left: 8px;">
                    <option value="planta">Planta</option>
                    <option value="controlador">Controlador</option>
                    <option value="malha_fechada" selected>Malha Fechada</option>
                    <option value="malha_aberta">Malha Aberta</option>
                </select>
            </div>
            <div id="container-plot-pz-closed" style="margin-bottom: 16px; display:none;">
                <div id="plot_pz_closed"></div>
            </div>

            <!-- Resposta ao Degrau (Malha Aberta) -->
            <div id="malha-aberta-container">
                <div style="display: flex; align-items: center; margin-bottom: 4px; margin-top: 16px;">
                    <button id="seta-grafico-malha-aberta" class="seta-grafico-btn" style="background:none;border:none;font-size:1.3em;cursor:pointer;color:#2196f3;margin-right:6px;">&#x25BC;</button>
                    <h4 style="margin: 0 8px 0 0;">Resposta ao Degrau (Malha Aberta)</h4>
                </div>
                <div id="plot_open" style="display:none;"></div>
            </div>

            <!-- Diagrama de Bode -->
            <div style="display: flex; align-items: center; margin-bottom: 4px; margin-top: 16px;">
                <button id="seta-grafico-bode" class="seta-grafico-btn" style="background:none;border:none;font-size:1.3em;cursor:pointer;color:#2196f3;margin-right:6px;">&#x25BC;</button>
                <h4 style="margin: 0 8px 0 0;">Diagrama de Bode</h4>
            </div>
            <div id="container-plot-bode" style="margin-bottom: 16px; display:none;">
                <div id="plot_bode"></div>
            </div>

            <!-- Diagrama de Nyquist -->
            <div style="display: flex; align-items: center; margin-bottom: 4px; margin-top: 16px;">
                <button id="seta-grafico-nyquist" class="seta-grafico-btn" style="background:none;border:none;font-size:1.3em;cursor:pointer;color:#2196f3;margin-right:6px;">&#x25BC;</button>
                <h4 style="margin: 0 8px 0 0;">Diagrama de Nyquist</h4>
            </div>
            <div id="nyquist-img-container" style="display:none;">
                <img id="nyquist-img" src="" alt="Diagrama de Nyquist" style="max-width:100%;border:1px solid #ccc;">
            </div>
        </div>
    </div>

    <div id="modal-feedback" class="modal">
        <div class="modal-content">
            <span class="close" id="fechar-modal">&times;</span>
            <h3>Envie seu Feedback</h3>
            <textarea id="feedback-texto" rows="6" style="width: 100%;" placeholder="Digite seu feedback aqui..."></textarea>
            <button id="enviar-feedback">Enviar</button>
        </div>
    </div>

    <script>
    // --- Estado dos polos e zeros ---
let polosPlanta = [-1];
let zerosPlanta = [];
let polosControlador = [-1];
let zerosControlador = [];

function renderInputs() {
    // Planta - Polos
    const polosList = document.getElementById('planta-polos-list');
    polosList.innerHTML = '';
    polosPlanta.forEach((val, idx) => {
        const row = document.createElement('div');
        row.className = 'input-row';
        row.innerHTML = `
            <input type="range" class="param-slider" id="polo-planta-slider-${idx}" min="-10" max="1" step="0.01" value="${val}">
            <input type="number" id="polo-planta-input-${idx}" step="0.01" min="-10" max="1" value="${val}">
            <button type="button" class="remove-btn" id="remove-planta-polo-${idx}" title="Remover Polo">&times;</button>
        `;
        polosList.appendChild(row);
        // Input num√©rico
        document.getElementById(`polo-planta-input-${idx}`).oninput = function() {
            polosPlanta[idx] = parseFloat(this.value);
            document.getElementById(`polo-planta-slider-${idx}`).value = this.value;
            atualizarTudo();
        };
        // Slider
        document.getElementById(`polo-planta-slider-${idx}`).oninput = function() {
            polosPlanta[idx] = parseFloat(this.value);
            document.getElementById(`polo-planta-input-${idx}`).value = this.value;
            atualizarTudo();
        };
        // Remover
        document.getElementById(`remove-planta-polo-${idx}`).onclick = function() {
            if (polosPlanta.length > 1) {
                polosPlanta.splice(idx, 1);
                renderInputs();
                atualizarTudo();
            }
        };
    });
    // Planta - Zeros
    const zerosList = document.getElementById('planta-zeros-list');
    zerosList.innerHTML = '';
    zerosPlanta.forEach((val, idx) => {
        const row = document.createElement('div');
        row.className = 'input-row';
        row.innerHTML = `
            <input type="range" class="param-slider" id="zero-planta-slider-${idx}" min="-10" max="10" step="0.01" value="${val}">
            <input type="number" id="zero-planta-input-${idx}" step="0.01" min="-10" max="10" value="${val}">
            <button type="button" class="remove-btn" id="remove-planta-zero-${idx}" title="Remover Zero">&times;</button>
        `;
        zerosList.appendChild(row);
        // Input num√©rico
        document.getElementById(`zero-planta-input-${idx}`).oninput = function() {
            zerosPlanta[idx] = parseFloat(this.value);
            document.getElementById(`zero-planta-slider-${idx}`).value = this.value;
            atualizarTudo();
        };
        // Slider
        document.getElementById(`zero-planta-slider-${idx}`).oninput = function() {
            zerosPlanta[idx] = parseFloat(this.value);
            document.getElementById(`zero-planta-input-${idx}`).value = this.value;
            atualizarTudo();
        };
        // Remover
        document.getElementById(`remove-planta-zero-${idx}`).onclick = function() {
            zerosPlanta.splice(idx, 1);
            renderInputs();
            atualizarTudo();
        };
    });
    // Controlador - Polos
    const polosListC = document.getElementById('controlador-polos-list');
    polosListC.innerHTML = '';
    polosControlador.forEach((val, idx) => {
        const row = document.createElement('div');
        row.className = 'input-row';
        row.innerHTML = `
            <input type="range" class="param-slider" id="polo-controlador-slider-${idx}" min="-10" max="1" step="0.01" value="${val}">
            <input type="number" id="polo-controlador-input-${idx}" step="0.01" min="-10" max="1" value="${val}">
            <button type="button" class="remove-btn" id="remove-controlador-polo-${idx}" title="Remover Polo">&times;</button>
        `;
        polosListC.appendChild(row);
        // Input num√©rico
        document.getElementById(`polo-controlador-input-${idx}`).oninput = function() {
            polosControlador[idx] = parseFloat(this.value);
            document.getElementById(`polo-controlador-slider-${idx}`).value = this.value;
            atualizarTudo();
        };
        // Slider
        document.getElementById(`polo-controlador-slider-${idx}`).oninput = function() {
            polosControlador[idx] = parseFloat(this.value);
            document.getElementById(`polo-controlador-input-${idx}`).value = this.value;
            atualizarTudo();
        };
        // Remover
        document.getElementById(`remove-controlador-polo-${idx}`).onclick = function() {
            if (polosControlador.length > 1) {
                polosControlador.splice(idx, 1);
                renderInputs();
                atualizarTudo();
            }
        };
    });
    // Controlador - Zeros
    const zerosListC = document.getElementById('controlador-zeros-list');
    zerosListC.innerHTML = '';
    zerosControlador.forEach((val, idx) => {
        const row = document.createElement('div');
        row.className = 'input-row';
        row.innerHTML = `
            <input type="range" class="param-slider" id="zero-controlador-slider-${idx}" min="-10" max="10" step="0.01" value="${val}">
            <input type="number" id="zero-controlador-input-${idx}" step="0.01" min="-10" max="10" value="${val}">
            <button type="button" class="remove-btn" id="remove-controlador-zero-${idx}" title="Remover Zero">&times;</button>
        `;
        zerosListC.appendChild(row);
        // Input num√©rico
        document.getElementById(`zero-controlador-input-${idx}`).oninput = function() {
            zerosControlador[idx] = parseFloat(this.value);
            document.getElementById(`zero-controlador-slider-${idx}`).value = this.value;
            atualizarTudo();
        };
        // Slider
        document.getElementById(`zero-controlador-slider-${idx}`).oninput = function() {
            zerosControlador[idx] = parseFloat(this.value);
            document.getElementById(`zero-controlador-input-${idx}`).value = this.value;
            atualizarTudo();
        };
        // Remover
        document.getElementById(`remove-controlador-zero-${idx}`).onclick = function() {
            zerosControlador.splice(idx, 1);
            renderInputs();
            atualizarTudo();
        };
    });
}

function setupBtns() {
    document.getElementById('add-planta-polo-btn').onclick = function() {
        polosPlanta.push(-1);
        renderInputs();
        atualizarTudo();
    };
    document.getElementById('add-planta-zero-btn').onclick = function() {
        zerosPlanta.push(0);
        renderInputs();
        atualizarTudo();
    };
    document.getElementById('add-controlador-polo-btn').onclick = function() {
        polosControlador.push(-1);
        renderInputs();
        atualizarTudo();
    };
    document.getElementById('add-controlador-zero-btn').onclick = function() {
        zerosControlador.push(0);
        renderInputs();
        atualizarTudo();
    };
    document.getElementById('ganho-controlador').oninput = atualizarTudo;
    document.getElementById('input-t-fechada-grafico').oninput = atualizarTudo;
    document.getElementById('input-a-fechada-grafico').oninput = atualizarTudo;
}

async function atualizarTudo() {
    // Valida√ß√£o: zeros n√£o podem ser mais que polos
    if (zerosPlanta.length > polosPlanta.length) {
        alert("A planta n√£o pode ter mais zeros do que polos!");
        return;
    }
    if (zerosControlador.length > polosControlador.length) {
        alert("O controlador n√£o pode ter mais zeros do que polos!");
        return;
    }

    // Monte os dados para o backend
    const ganhoControlador = parseFloat(document.getElementById('ganho-controlador').value);
    const t_perturb_fechada = parseFloat(document.getElementById('input-t-fechada-grafico').value);
    const amp_perturb_fechada = parseFloat(document.getElementById('input-a-fechada-grafico').value);

    const data = {
        polos_planta: polosPlanta,
        zeros_planta: zerosPlanta,
        polos_controlador: polosControlador,
        zeros_controlador: zerosControlador,
        ganho_controlador: ganhoControlador,
        t_perturb_fechada: t_perturb_fechada,
        amp_perturb_fechada: amp_perturb_fechada
    };

    // Chame o backend normalmente (igual j√° faz)
    const res = await fetch('/atualizar_pagina4', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });
    const json = await res.json();

    document.getElementById("ft-planta-polinomial").innerHTML = json.latex_planta_polinomial || "Erro ao carregar forma polinomial";
    document.getElementById("ft-planta-fatorada").innerHTML = json.latex_planta_fatorada || "Erro ao carregar forma fatorada";
    document.getElementById("ft-planta-parcial").innerHTML = json.latex_planta_parcial || "Erro ao carregar fra√ß√£o parcial";

    document.getElementById("ft-controlador-polinomial").innerHTML = json.latex_controlador_polinomial || "Erro ao carregar forma polinomial";
    document.getElementById("ft-controlador-fatorada").innerHTML = json.latex_controlador_fatorada || "Erro ao carregar forma fatorada";
    document.getElementById("ft-controlador-parcial").innerHTML = json.latex_controlador_parcial || "Erro ao carregar fra√ß√£o parcial";

    if (window.MathJax) MathJax.typesetPromise();

    // Apenas atualize os gr√°ficos que s√£o exclusivos deste endpoint
    Plotly.newPlot('plot_open', json.plot_open_data.data, json.plot_open_data.layout);
    Plotly.newPlot('plot_closed', json.plot_closed_data.data, json.plot_closed_data.layout);

    // Removido: Plotly.newPlot('plot_pz_closed', ...) e Plotly.newPlot('plot_bode', ...)
    // Eles s√£o atualizados separadamente nas fun√ß√µes abaixo

    // Atualize os gr√°ficos restantes
    await atualizarPZClosed();
    await atualizarBode();
    await atualizarNyquist();
}

window.onload = function() {
    renderInputs();
    setupBtns();
    atualizarTudo();
};

document.getElementById('select-ft-planta').onchange = function() {
    let val = this.value;
    document.getElementById('ft-planta-fatorada').style.display = val === 'fatorada' ? '' : 'none';
    document.getElementById('ft-planta-polinomial').style.display = val === 'polinomial' ? '' : 'none';
    document.getElementById('ft-planta-parcial').style.display = val === 'parcial' ? '' : 'none';
};
document.getElementById('select-ft-controlador').onchange = function() {
    let val = this.value;
    document.getElementById('ft-controlador-fatorada').style.display = val === 'fatorada' ? '' : 'none';
    document.getElementById('ft-controlador-polinomial').style.display = val === 'polinomial' ? '' : 'none';
    document.getElementById('ft-controlador-parcial').style.display = val === 'parcial' ? '' : 'none';
};

function toggleSection(btnId, sectionId) {
    const btn = document.getElementById(btnId);
    const section = document.getElementById(sectionId);
    btn.onclick = function() {
        if (section.style.display === "none") {
            section.style.display = "";
            btn.innerHTML = "&#x25BC;";
        } else {
            section.style.display = "none";
            btn.innerHTML = "&#x25B6;";
        }
    };
}

// Associe cada bot√£o √† sua se√ß√£o
window.addEventListener('DOMContentLoaded', function() {
    toggleSection('seta-grafico-closed', 'container-plot-closed');
    toggleSection('seta-grafico-pz-closed', 'container-plot-pz-closed');
    toggleSection('seta-grafico-malha-aberta', 'plot_open');
    toggleSection('seta-grafico-bode', 'container-plot-bode');
    toggleSection('seta-grafico-nyquist', 'nyquist-img-container');
});

async function atualizarNyquist() {
    const data = {
        polos_planta: polosPlanta,
        zeros_planta: zerosPlanta,
        polos_controlador: polosControlador,
        zeros_controlador: zerosControlador,
        ganho_controlador: parseFloat(document.getElementById('ganho-controlador').value)
    };
    const res = await fetch('/nyquist_pagina4', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });
    const json = await res.json();
    document.getElementById('nyquist-img').src = "data:image/png;base64," + json.nyquist_img;
}

async function atualizarPZClosed() {
    const tipo = document.getElementById('tipo-diagrama-pz').value;
    let data = {
        polos_planta: polosPlanta,
        zeros_planta: zerosPlanta,
        polos_controlador: polosControlador,
        zeros_controlador: zerosControlador,
        ganho_controlador: parseFloat(document.getElementById('ganho-controlador').value),
        tipo: tipo // Envia o tipo para o backend
    };

    // L√≥gica did√°tica para cada tipo:
    // - Planta: mostra apenas polos e zeros da planta (G(s))
    // - Controlador: mostra apenas polos e zeros do controlador (Gc(s))
    // - Malha Fechada: mostra polos e zeros do sistema em malha fechada (G(s)*Gc(s)/(1+G(s)*Gc(s)))
    // - Malha Aberta: mostra polos e zeros do sistema em malha aberta (G(s)*Gc(s))

    const res = await fetch('/atualizar_pz_closed', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });
    const json = await res.json();
    Plotly.newPlot('plot_pz_closed', json.plot_pz_closed.data, json.plot_pz_closed.layout);
}

// Atualiza o diagrama ao trocar o tipo
document.getElementById('tipo-diagrama-pz').onchange = atualizarPZClosed;

async function atualizarBode() {
    const data = {
        polos_planta: polosPlanta,
        zeros_planta: zerosPlanta,
        polos_controlador: polosControlador,
        zeros_controlador: zerosControlador,
        ganho_controlador: parseFloat(document.getElementById('ganho-controlador').value)
    };
    const res = await fetch('/atualizar_bode', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });
    const json = await res.json();
    Plotly.newPlot('plot_bode', json.bode_data.data, json.bode_data.layout);
}

// Menu hamburguer igual pagina2: abre ao passar mouse, fecha ao sair
document.addEventListener('DOMContentLoaded', function() {
    const menu = document.querySelector('.menu');
    const menuContent = document.querySelector('.menu-content');
    let closeMenuTimeout = null;

    menu.addEventListener('mouseenter', () => {
        if (closeMenuTimeout) {
            clearTimeout(closeMenuTimeout);
            closeMenuTimeout = null;
        }
        menu.classList.add('open');
        menuContent.style.display = 'block';
    });

    menu.addEventListener('mouseleave', () => {
        closeMenuTimeout = setTimeout(() => {
            menu.classList.remove('open');
            menuContent.style.display = 'none';
        }, 300); // 0.5 segundos
    });

    // Se o mouse voltar antes do timeout, cancela o fechamento
    menu.addEventListener('mouseenter', () => {
        if (closeMenuTimeout) {
            clearTimeout(closeMenuTimeout);
            closeMenuTimeout = null;
        }
        menu.classList.add('open');
        menuContent.style.display = 'block';
    });

    document.getElementById('dark-mode-toggle').addEventListener('change', (event) => {
        document.body.classList.toggle('dark-mode', event.target.checked);
    });
    // Feedback modal
    document.getElementById('abrir-feedback').onclick = function() {
        document.getElementById('modal-feedback').style.display = 'block';
    };
    document.getElementById('fechar-modal').onclick = function() {
        document.getElementById('modal-feedback').style.display = 'none';
    };
    window.onclick = function(event) {
        if (event.target == document.getElementById('modal-feedback')) {
            document.getElementById('modal-feedback').style.display = 'none';
        }
    };
    document.getElementById('enviar-feedback').onclick = async function() {
        const texto = document.getElementById('feedback-texto').value;
        const res = await fetch('/enviar_feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ feedback: texto })
        });
        if (res.ok) {
            alert('Feedback enviado com sucesso!');
            document.getElementById('modal-feedback').style.display = 'none';
            document.getElementById('feedback-texto').value = '';
        } else {
            alert('Erro ao enviar feedback.');
        }
    };
    document.getElementById('dark-mode-toggle-btn').addEventListener('click', function() {
        document.body.classList.toggle('dark-mode');
        // Troca o √≠cone conforme o modo
        document.getElementById('dark-mode-icon').textContent =
            document.body.classList.contains('dark-mode') ? 'üåû' : 'üåô';
    });
});
    </script>
</body>
</html>